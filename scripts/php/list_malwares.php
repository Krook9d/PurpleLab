<?php
// Path to directory containing malware
$malwareDirectory = '/var/www/html/Downloaded/malware_upload/';

// Open directory
$dir = new DirectoryIterator($malwareDirectory);

// Array to store file information
$files = [];

foreach ($dir as $fileinfo) {
    if (!$fileinfo->isDot() && $fileinfo->getFilename() !== 'upload.md') {
        $filename = $fileinfo->getFilename();
        $filesize = $fileinfo->getSize();
        $fileExtension = strtolower($fileinfo->getExtension());
        $fileCreationDate = $fileinfo->getMTime();
        
        $files[] = [
            'name' => $filename,
            'size' => $filesize,
            'extension' => $fileExtension,
            'date' => $fileCreationDate
        ];
    }
}

// Sort files by creation date (newest first)
usort($files, function($a, $b) {
    return $b['date'] - $a['date'];
});

// Function to format file size
function formatFileSize($bytes) {
    if ($bytes == 0) return '0 B';
    $sizes = array('B', 'KB', 'MB', 'GB', 'TB');
    $factor = floor((strlen($bytes) - 1) / 3);
    return sprintf("%.2f", $bytes / pow(1024, $factor)) . ' ' . @$sizes[$factor];
}

// Function to get file type icon
function getFileIcon($extension) {
    $icons = [
        'exe' => 'ðŸ—ƒï¸',
        'dll' => 'âš™ï¸',
        'bin' => 'ðŸ“¦',
        'py' => 'ðŸ',
        'ps1' => 'ðŸ’™',
        'pdf' => 'ðŸ“„',
        'ods' => 'ðŸ“Š',
        'xlsx' => 'ðŸ“Š',
        'default' => 'ðŸ“„'
    ];
    return $icons[$extension] ?? $icons['default'];
}

// Function to get file type badge color
function getFileTypeBadge($extension) {
    $badges = [
        'exe' => 'danger',
        'dll' => 'warning',
        'bin' => 'danger',
        'py' => 'success',
        'ps1' => 'info',
        'pdf' => 'secondary',
        'ods' => 'primary',
        'xlsx' => 'primary',
        'default' => 'secondary'
    ];
    return $badges[$extension] ?? $badges['default'];
}

if (empty($files)) {
    echo "<div class='malware-list-empty'>
            <div class='empty-icon'>ðŸ“‚</div>
            <h3>No malware files found</h3>
            <p>Upload some malware files to see them listed here.</p>
          </div>";
} else {
    $output = "<div class='malware-list-container'>";
    $output .= "<div class='malware-list-header'>";
    $output .= "<h3><i class='fas fa-virus'></i> Hosted Malware Files (" . count($files) . ")</h3>";
    $output .= "</div>";
    
    $output .= "<table class='malware-list-table'>";
    $output .= "<thead>
                    <tr>
                        <th><i class='fas fa-file'></i> File</th>
                        <th><i class='fas fa-weight-hanging'></i> Size</th>
                        <th><i class='fas fa-tag'></i> Type</th>
                        <th><i class='fas fa-calendar'></i> Added</th>
                        <th><i class='fas fa-cog'></i> Actions</th>
                    </tr>
                </thead><tbody>";

    foreach ($files as $file) {
        $humanFileSize = formatFileSize($file['size']);
        $fileIcon = getFileIcon($file['extension']);
        $fileBadge = getFileTypeBadge($file['extension']);
        $fileCreationDate = date("M d, Y H:i", $file['date']);
        $relativeTime = date('Y-m-d') === date('Y-m-d', $file['date']) ? 'Today' : date("M d", $file['date']);
        
        $output .= "<tr class='malware-row'>";
        $output .= "<td class='file-info'>
                        <div class='file-icon'>{$fileIcon}</div>
                        <div class='file-details'>
                            <div class='file-name'>{$file['name']}</div>
                            <div class='file-path'>/Downloaded/malware_upload/</div>
                        </div>
                    </td>";
        $output .= "<td class='file-size'>{$humanFileSize}</td>";
        $output .= "<td class='file-type'><span class='type-badge type-{$fileBadge}'>{$file['extension']}</span></td>";
        $output .= "<td class='file-date'>
                        <div class='date-primary'>{$relativeTime}</div>
                        <div class='date-secondary'>{$fileCreationDate}</div>
                    </td>";
        $output .= "<td class='file-actions'>
                        <button class='runMalware action-btn run-btn' data-filename='{$file['name']}' title='Execute malware'>
                            <i class='fas fa-play'></i> Run
                        </button>
                        <button class='action-btn delete-btn' onclick='deleteMalware(\"{$file['name']}\")' title='Delete file'>
                            <i class='fas fa-trash'></i>
                        </button>
                    </td>";
        $output .= "</tr>";
    }

    $output .= "</tbody></table>";
    $output .= "</div>";
    
    echo $output;
}
?>

