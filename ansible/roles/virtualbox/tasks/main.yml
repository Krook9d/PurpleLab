---
- name: Installation de VirtualBox
  apt:
    name: virtualbox
    state: present

- name: Importer la VM sandbox
  shell: VBoxManage import /var/www/html/sandbox.ova
  args:
    creates: "~/.config/VirtualBox/VirtualBox.xml"
  ignore_errors: yes

- name: Configuration de la VM (CPU et RAM)
  shell: VBoxManage modifyvm "sandbox" --memory "{{ vm_memory }}" --cpus "{{ vm_cpus }}"
  changed_when: false
  ignore_errors: yes

- name: Lister les interfaces réseau disponibles
  shell: ip -o -4 addr show | awk '{print $2, $4}'
  register: network_interfaces
  changed_when: false

- name: Afficher les interfaces réseau
  debug:
    var: network_interfaces.stdout_lines

- name: Demander quelle interface utiliser
  pause:
    prompt: "Veuillez entrer le nom de l'interface réseau à utiliser pour la VM"
  register: chosen_interface

- name: Configurer l'interface réseau de la VM
  shell: VBoxManage modifyvm sandbox --nic1 bridged --bridgeadapter1 "{{ chosen_interface.user_input }}"
  changed_when: false
  ignore_errors: yes

- name: Démarrer la VM sandbox en mode headless
  shell: VBoxManage startvm "sandbox" --type headless
  changed_when: false
  ignore_errors: yes

- name: Attendre que la VM soit démarrée
  shell: VBoxManage showvminfo "sandbox" | grep -q "State.*running"
  register: vm_running
  until: vm_running.rc == 0
  retries: 30
  delay: 5
  ignore_errors: yes
  changed_when: false

- name: Récupérer l'adresse IP de la VM sandbox
  shell: VBoxManage guestproperty get sandbox "/VirtualBox/GuestInfo/Net/0/V4/IP" | awk '{print $2}'
  register: vm_ip
  changed_when: false
  ignore_errors: yes
  when: vm_running.rc == 0

- name: Afficher l'adresse IP de la VM sandbox
  debug:
    msg: "La machine sandbox est démarrée avec succès et son adresse IP est accessible via RDP à : {{ vm_ip.stdout }}"
  when: vm_ip.stdout is defined and vm_ip.stdout != "" 