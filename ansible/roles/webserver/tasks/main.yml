---
- name: Configuration de VirtualHost Apache
  copy:
    content: |
      <VirtualHost *:80>
          DirectoryIndex index.php
      </VirtualHost>
    dest: /etc/apache2/sites-available/000-default.conf
  notify: Redémarrer Apache

- name: Installation de Composer
  shell: |
    curl -sS https://getcomposer.org/installer | php
    mv composer.phar /usr/local/bin/composer
  args:
    creates: /usr/local/bin/composer

- name: Déplacer les fichiers PurpleLab vers le webroot
  shell: |
    cp -r /home/{{ ansible_user }}/PurpleLab/* /var/www/html/
    if [ -d "/var/www/html/Web" ]; then
      cp -r /var/www/html/Web/* /var/www/html/
      rm -rf /var/www/html/Web
    fi
  ignore_errors: yes

- name: Déplacer app.py vers le répertoire de l'utilisateur
  copy:
    src: files/app.py
    dest: "/home/{{ ansible_user }}/app.py"
    remote_src: yes
    mode: '0755'

- name: Installation de PhpSpreadsheet
  become_user: www-data
  composer:
    command: require
    arguments: phpoffice/phpspreadsheet
    working_dir: /var/www/html
    no_dev: yes
  ignore_errors: yes

- name: Supprimer index.html par défaut
  file:
    path: /var/www/html/index.html
    state: absent

- name: Définir les permissions appropriées
  file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    recurse: "{{ item.recurse | default(no) }}"
  with_items:
    - { path: '/var/www/html/', mode: '0775', recurse: yes }
    - { path: '/var/www/html/uploads/', mode: '0770', recurse: yes }
    - { path: '/var/www/html/Downloaded/malware_upload/', mode: '0777', recurse: yes }
    - { path: '/var/www/html/config/', mode: '0750', recurse: no }

- name: Définir les permissions pour admin.php
  file:
    path: /var/www/html/admin.php
    mode: '0755'
    state: file

- name: Ajouter les variables d'environnement à Apache
  lineinfile:
    path: /etc/apache2/envvars
    line: "{{ item }}"
  with_items:
    - "export DB_HOST='localhost'"
    - "export DB_USER='{{ db_user }}'"
    - "export DB_PASS='{{ db_pass }}'"
    - "export DB_NAME='{{ db_name }}'"
    - "export ENCRYPTION_KEY='{{ encryption_key }}'"
  notify: Redémarrer Apache 
